<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü–∞–∑–ª ‚Äî –†–∞–∫–µ—Ç–∞</title>

<style>
  body{
    margin:0;
    background:#eaf2ff;
    font-family:Arial, sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
    padding-top:20px;
  }

  h1{margin-bottom:10px;}

  #menu{
    margin-bottom:10px;
    display:flex;
    gap:10px;
    align-items:center;
  }

  select,button{
    font-size:16px;
    padding:6px 12px;
  }

  button{
    background:#4f46e5;
    color:#fff;
    border:0;
    border-radius:6px;
    cursor:pointer;
  }

  #wrap{
    position:relative;
    width:90vw;
    max-width:720px;
    aspect-ratio:3/2;
    border:3px solid #1f2937;
    border-radius:12px;
    overflow:hidden;
    background:#cdd7ff;
    touch-action:none;
  }

  #target{
    position:absolute;
    inset:0;
    background-size:100% 100%;
    opacity:0.14;
    pointer-events:none;
  }

  .piece{
    position:absolute;
    background-size:300% 300%;
    cursor:grab;
    border:1px solid #222;
    border-radius:6px;
    box-shadow:0 4px 10px rgba(0,0,0,.2);
    transition:box-shadow .2s;
  }

  .locked{
    cursor:default;
    box-shadow:none !important;
    border:2px solid #22c55e;
  }

  #msg{
    margin-top:15px;
    font-size:22px;
    color:#16a34a;
    font-weight:bold;
    display:none;
  }
</style>
</head>
<body>

<h1>–ü–∞–∑–ª ‚Äî –°–æ–±–µ—Ä–∏ —Ä–∞–∫–µ—Ç—É</h1>

<div id="menu">
  <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å:
    <select id="lvl">
      <option value="3">–õ—ë–≥–∫–æ (3√ó3)</option>
      <option value="4">–°—Ä–µ–¥–Ω–µ (4√ó4)</option>
      <option value="5">–°–ª–æ–∂–Ω–æ (5√ó5)</option>
    </select>
  </label>

  <button id="restart">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
</div>

<div id="wrap">
  <div id="target"></div>
</div>

<div id="msg">–£—Ä–∞! –†–∞–∫–µ—Ç–∞ —Å–æ–±—Ä–∞–Ω–∞ üéâ</div>

<script>
(() => {

  const IMG = "rocket.png";  
  const SNAP = 30;           // —Ä–∞–¥–∏—É—Å –ø—Ä–∏–ª–∏–ø–∞–Ω–∏—è

  const wrap = document.getElementById("wrap");
  const target = document.getElementById("target");
  const msg = document.getElementById("msg");
  const lvlSel = document.getElementById("lvl");
  const restartBtn = document.getElementById("restart");

  target.style.backgroundImage = `url(${IMG})`;

  let pieces = [];
  let placed = 0;
  let N = 3;

  restartBtn.onclick = init;
  lvlSel.onchange = init;

  function init(){
    msg.style.display = "none";
    pieces.forEach(p=>p.remove());
    pieces = [];
    placed = 0;

    N = parseInt(lvlSel.value,10);

    const W = wrap.clientWidth;
    const H = wrap.clientHeight;
    const pw = W / N;
    const ph = H / N;

    const usedPositions = [];

    // ======================
    //  –°–û–ó–î–ê–Å–ú –í–°–ï –ö–£–°–û–ß–ö–ò
    // ======================
    for(let r=0; r<N; r++){
      for(let c=0; c<N; c++){
        const idx = r*N + c;

        const el = document.createElement("div");
        el.className = "piece";
        el.dataset.idx = idx;
        el.dataset.correctX = c * pw;
        el.dataset.correctY = r * ph;

        el.style.width = pw + "px";
        el.style.height = ph + "px";
        el.style.backgroundImage = `url(${IMG})`;
        el.style.backgroundSize = `${N*100}% ${N*100}%`;
        el.style.backgroundPosition = `${(c/(N-1))*100}% ${(r/(N-1))*100}%`;

        // ----------------------------
        //  –°–õ–£–ß–ê–ô–ù–û–ï –†–ê–ó–ú–ï–©–ï–ù–ò–ï –ë–ï–ó –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø
        // ----------------------------
        let x, y, tries = 0;

        do {
          x = Math.random() * (W - pw);
          y = Math.random() * (H - ph);

          var overlap = usedPositions.some(p => {
            return !(x+pw < p.x || x > p.x+pw || y+ph < p.y || y > p.y+ph);
          });

          tries++;
          if(tries > 300) break; // –∑–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
        } while(overlap);

        usedPositions.push({x,y});

        el.style.left = x + "px";
        el.style.top = y + "px";

        wrap.appendChild(el);
        pieces.push(el);

        enableDrag(el);
      }
    }
  }


  // ===========================================
  //                 –î–†–ê–ì
  // ===========================================

  function enableDrag(el){
    let dragging = false;
    let ox, oy;

    function down(e){
      if(el.classList.contains("locked")) return;

      dragging = true;

      const p = (e.touches ? e.touches[0] : e);
      const rect = el.getBoundingClientRect();
      const wrect = wrap.getBoundingClientRect();

      ox = p.clientX - rect.left;
      oy = p.clientY - rect.top;

      el.style.transition = "none";
      el.style.zIndex = 20;
      el.style.boxShadow = "0 0 0 3px #22c55e inset, 0 10px 20px rgba(0,0,0,.3)";

      window.addEventListener("mousemove", move);
      window.addEventListener("mouseup", up);

      window.addEventListener("touchmove", move, {passive:false});
      window.addEventListener("touchend", up);
    }

    function move(e){
      if(!dragging) return;
      e.preventDefault();

      const p = (e.touches ? e.touches[0] : e);
      const wrect = wrap.getBoundingClientRect();

      const x = p.clientX - wrect.left - ox;
      const y = p.clientY - wrect.top - oy;

      el.style.left = x + "px";
      el.style.top = y + "px";
    }

    function up(){
      if(!dragging) return;
      dragging = false;

      el.style.zIndex = 1;
      el.style.boxShadow = "";

      snap(el);

      window.removeEventListener("mousemove", move);
      window.removeEventListener("mouseup", up);
      window.removeEventListener("touchmove", move);
      window.removeEventListener("touchend", up);
    }

    el.addEventListener("mousedown", down);
    el.addEventListener("touchstart", down, {passive:true});
  }


  // ===========================================
  //              –ü–†–ò–õ–ò–ü–ê–ù–ò–ï
  // ===========================================

  function snap(el){
    const correctX = parseFloat(el.dataset.correctX);
    const correctY = parseFloat(el.dataset.correctY);

    const x = parseFloat(el.style.left);
    const y = parseFloat(el.style.top);

    if(Math.abs(x - correctX) < SNAP && Math.abs(y - correctY) < SNAP){
      el.style.left = correctX + "px";
      el.style.top = correctY + "px";

      el.classList.add("locked");
      placed++;

      if(placed === N*N){
        msg.style.display = "block";
      }
    }
  }

  init();

})();
</script>

</body>
</html>
