<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü–∞–∑–ª ‚Äî –†–∞–∫–µ—Ç–∞</title>

<style>
  body{
    margin:0;
    background:#eaf2ff;
    font-family:Arial, sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
    padding-top:20px;
  }

  h1{margin-bottom:10px;}

  #menu{
    margin-bottom:10px;
    display:flex;
    gap:10px;
    align-items:center;
  }

  #wrap{
    position:relative;
    width:90vw;
    max-width:720px;
    aspect-ratio:3/2;
    border:3px solid #1f2937;
    border-radius:12px;
    background:#cdd7ff;
    overflow:hidden;
  }

  #target{
    position:absolute;
    inset:0;
    background-size:100% 100%;
    opacity:0.12;
    pointer-events:none;
  }

  .piece{
    position:absolute;
    background-size:300% 300%;
    border:1px solid #222;
    border-radius:6px;
    cursor:grab;
    touch-action:none;
    box-shadow:0 4px 10px rgba(0,0,0,.25);
    transition:box-shadow .15s;
  }

  #msg{
    margin-top:15px;
    font-size:22px;
    color:#16a34a;
    font-weight:bold;
    display:none;
  }
</style>
</head>

<body>

<h1>–ü–∞–∑–ª ‚Äî –°–æ–±–µ—Ä–∏ —Ä–∞–∫–µ—Ç—É</h1>

<div id="menu">
  <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å:
    <select id="lvl">
      <option value="3">3√ó3</option>
      <option value="4">4√ó4</option>
      <option value="5">5√ó5</option>
    </select>
  </label>

  <button id="restart">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
</div>

<div id="wrap">
  <div id="target"></div>
</div>

<div id="msg">–£—Ä–∞! –†–∞–∫–µ—Ç–∞ —Å–æ–±—Ä–∞–Ω–∞ üéâ</div>

<script>
(() => {

  const IMG = "rocket.png";
  const SNAP = 30;

  const wrap = document.getElementById("wrap");
  const target = document.getElementById("target");
  const msg = document.getElementById("msg");
  const lvlSel = document.getElementById("lvl");
  const restartBtn = document.getElementById("restart");

  target.style.backgroundImage = `url(${IMG})`;

  let pieces = [];
  let N = 3;

  restartBtn.onclick = init;
  lvlSel.onchange = init;

  // =============================
  //         –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
  // =============================
  function init(){
    msg.style.display = "none";
    pieces.forEach(p=>p.remove());
    pieces = [];

    N = parseInt(lvlSel.value,10);

    const W = wrap.clientWidth;
    const H = wrap.clientHeight;
    const pw = W / N;
    const ph = H / N;

    // –†–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≤–æ–∫—Ä—É–≥ –ø–æ–ª—è (–ë–µ–∑ –≤–µ—Ä—Ö–Ω–µ–π –∑–æ–Ω—ã)
    const margin = 20;
    const gap = 10;

    let coords = [];

    // –°–ù–ò–ó–£
    for(let i=0;i<N;i++){
      coords.push({
        x: wrap.offsetLeft + i*(pw+gap),
        y: wrap.offsetTop + H + margin
      });
    }

    // –°–õ–ï–í–ê
    for(let i=0;i<N;i++){
      coords.push({
        x: wrap.offsetLeft - pw - margin,
        y: wrap.offsetTop + i*(ph+gap)
      });
    }

    // –°–ü–†–ê–í–ê
    for(let i=0;i<N;i++){
      coords.push({
        x: wrap.offsetLeft + W + margin,
        y: wrap.offsetTop + i*(ph+gap)
      });
    }

    coords.sort(()=>Math.random()-0.5);

    let posIndex = 0;

    // —Å–æ–∑–¥–∞—ë–º –ø–∞–∑–ª-–∫—É—Å–æ—á–∫–∏
    for(let r=0; r<N; r++){
      for(let c=0; c<N; c++){
        const idx = r*N + c;

        const el = document.createElement("div");
        el.className = "piece";
        el.dataset.idx = idx;

        el.dataset.correctX = c * pw;
        el.dataset.correctY = r * ph;

        el.style.width = pw + "px";
        el.style.height = ph + "px";

        el.style.backgroundImage = `url(${IMG})`;
        el.style.backgroundSize = `${N*100}% ${N*100}%`;
        el.style.backgroundPosition = `${(c/(N-1))*100}% ${(r/(N-1))*100}%`;

        const pos = coords[posIndex++];
        el.style.left = pos.x + "px";
        el.style.top  = pos.y + "px";

        document.body.appendChild(el);
        pieces.push(el);
        enableDrag(el);
      }
    }
  }

  // =============================
  //           DRAG
  // =============================
  function enableDrag(el){
    let dragging = false;
    let ox=0, oy=0;

    function down(e){
      const p = (e.touches ? e.touches[0] : e);

      dragging = true;
      const rect = el.getBoundingClientRect();
      ox = p.clientX - rect.left;
      oy = p.clientY - rect.top;

      el.style.zIndex = 200;
      el.style.boxShadow = "0 0 0 3px #22c55e inset, 0 10px 20px rgba(0,0,0,.3)";

      window.addEventListener("mousemove", move);
      window.addEventListener("mouseup", up);
      window.addEventListener("touchmove", move, {passive:false});
      window.addEventListener("touchend", up);
    }

    function move(e){
      if(!dragging) return;
      e.preventDefault();

      const p = (e.touches ? e.touches[0] : e);
      const x = p.clientX - ox;
      const y = p.clientY - oy;

      el.style.left = x + "px";
      el.style.top = y + "px";
    }

    function up(){
      if(!dragging) return;
      dragging = false;

      el.style.boxShadow = "";
      el.style.zIndex = 1;

      snap(el);
      checkComplete();

      window.removeEventListener("mousemove", move);
      window.removeEventListener("mouseup", up);
      window.removeEventListener("touchmove", move);
      window.removeEventListener("touchend", up);
    }

    el.addEventListener("mousedown", down);
    el.addEventListener("touchstart", down, {passive:true});
  }

  // =============================
  //        –ü–†–ò–õ–ò–ü–ê–ù–ò–ï
  // =============================
  function snap(el){
    const correctX = parseFloat(el.dataset.correctX);
    const correctY = parseFloat(el.dataset.correctY);

    const wrapRect = wrap.getBoundingClientRect();
    const x = parseFloat(el.style.left);
    const y = parseFloat(el.style.top);

    const dx = Math.abs(x - (wrapRect.left + correctX));
    const dy = Math.abs(y - (wrapRect.top + correctY));

    const inside =
      x >= wrapRect.left - SNAP &&
      y >= wrapRect.top  - SNAP &&
      x <= wrapRect.right + SNAP &&
      y <= wrapRect.bottom + SNAP;

    if(inside && dx < SNAP && dy < SNAP){
      el.style.left = wrapRect.left + correctX + "px";
      el.style.top  = wrapRect.top  + correctY + "px";
      el.dataset.locked = "1";
    } else {
      el.dataset.locked = "0";
    }
  }

  // =============================
  //      –ü–†–û–í–ï–†–ö–ê –°–û–ë–†–ê–ù–û–°–¢–ò
  // =============================
  function checkComplete(){
    let ok = 0;
    const wrapRect = wrap.getBoundingClientRect();

    for(const el of pieces){
      const correctX = wrapRect.left + parseFloat(el.dataset.correctX);
      const correctY = wrapRect.top  + parseFloat(el.dataset.correctY);

      const x = parseFloat(el.style.left);
      const y = parseFloat(el.style.top);

      if(Math.abs(x - correctX) < 5 && Math.abs(y - correctY) < 5){
        ok++;
      }
    }

    if(ok === pieces.length){
      msg.style.display = "block";
    }
  }

  init();

})();
</script>
</body>
</html>
