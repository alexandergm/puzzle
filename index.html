<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ü–∞–∑–ª: –†–∞–∫–µ—Ç–∞</title>
<style>
  :root{
    --w: 720px;   /* —à–∏—Ä–∏–Ω–∞ –ø–æ–ª—è */
    --h: 480px;   /* –≤—ã—Å–æ—Ç–∞ –ø–æ–ª—è 3:2 */
  }
  body{font-family: system-ui, Arial, sans-serif;background:#eaf2ff;margin:0;display:flex;flex-direction:column;align-items:center;min-height:100vh;}
  header{padding:18px 16px 6px}
  h1{margin:0;font-size:22px}
  #menu{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;padding:12px}
  select,button,label{font-size:16px}
  button{background:#4f46e5;color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:0 3px 0 #2f2ac4}
  button:active{transform:translateY(1px);box-shadow:0 2px 0 #2f2ac4}
  #wrap{position:relative;width:min(var(--w), 94vw);aspect-ratio:3/2;max-height:70vh}
  #puzzle{position:absolute;inset:0;border-radius:12px;overflow:hidden;border:3px solid #1f2937;background:#cdd7ff}
  #puzzle.solved{outline:4px solid #22c55e}
  .piece{position:absolute;box-sizing:border-box;border:1px solid #0f172a;background-repeat:no-repeat;background-size:100% 100%;transition:box-shadow .15s, transform .1s}
  .piece.focus{box-shadow:0 0 0 3px #22c55e inset, 0 8px 18px rgba(0,0,0,.2);z-index:5}
  #ghost{position:absolute;inset:0;background-size:100% 100%;opacity:.15;pointer-events:none;border-radius:10px}
  #msg{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(1px);border-radius:10px}
  #msg.show{display:flex}
  #msg .box{background:#fff;padding:18px 22px;border-radius:14px;font-size:22px;color:#111827;box-shadow:0 20px 40px rgba(0,0,0,.2)}
  #footer{opacity:.7;font-size:13px;padding:8px 0 18px}
</style>
</head>
<body>
  <header>
    <h1>–ü–∞–∑–ª ‚Äî —Å–æ–±–µ—Ä–∏ —Ä–∞–∫–µ—Ç—É</h1>
  </header>

  <div id="menu">
    <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å:
      <select id="size">
        <option value="3">–õ—ë–≥–∫–∏–π (9)</option>
        <option value="4">–°–ª–æ–∂–Ω—ã–π (16)</option>
      </select>
    </label>
    <button id="start">–°—Ç–∞—Ä—Ç / –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
    <label><input type="checkbox" id="hint" checked> –ü–æ–¥—Å–∫–∞–∑–∫–∞</label>
  </div>

  <div id="wrap">
    <div id="ghost"></div>
    <div id="puzzle" aria-label="–ü–æ–ª–µ –ø–∞–∑–ª–∞" role="grid"></div>
    <div id="msg"><div class="box">–£—Ä–∞! –†–∞–∫–µ—Ç–∞ —Å–æ–±—Ä–∞–Ω–∞ üéâ</div></div>
  </div>

<script>
(() => {
  const IMG_URL = 'rocket.png'; // –ü–æ–º–µ—Å—Ç–∏—Ç–µ —Å—é–¥–∞ –≤–∞—à—É –∫–∞—Ä—Ç–∏–Ω–∫—É (–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è) –∫–∞–∫ rocket.png

  const wrap = document.getElementById('wrap');
  const puzzle = document.getElementById('puzzle');
  const ghost = document.getElementById('ghost');
  const sizeSel = document.getElementById('size');
  const startBtn = document.getElementById('start');
  const hintChk = document.getElementById('hint');
  const msg = document.getElementById('msg');

  ghost.style.backgroundImage = `url(${IMG_URL})`;

  let N = 3;              // –∫–æ–ª-–≤–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –ø–æ —Å—Ç–æ—Ä–æ–Ω–µ
  let pieces = [];        // —ç–ª–µ–º–µ–Ω—Ç—ã DOM
  let order = [];         // —Ç–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫ (–∏–Ω–¥–µ–∫—Å—ã)
  let first = null;       // –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–ª—è –æ–±–º–µ–Ω–∞

  function createPieces(){
    puzzle.innerHTML = '';
    pieces = [];
    order = [];
    const W = puzzle.clientWidth;
    const H = puzzle.clientHeight;
    const w = W / N;
    const h = H / N;

    for(let r=0; r<N; r++){
      for(let c=0; c<N; c++){
        const i = r*N + c;  // –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
        const el = document.createElement('div');
        el.className = 'piece';
        el.style.width = `${100/N}%`;
        el.style.height = `${100/N}%`;
        el.dataset.correct = i;
        // –∫–∞–∂–¥—ã–π –∫—É—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—ë –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∞ –æ–∫–Ω–æ –æ–±—Ä–µ–∑–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —á–∞—Å—Ç—å —á–µ—Ä–µ–∑ background-position
        el.style.backgroundImage = `url(${IMG_URL})`;
        el.style.backgroundSize = `${N*100}% ${N*100}%`;
        el.style.backgroundPosition = `${(c/(N-1))*100}% ${(r/(N-1))*100}%`;
        puzzle.appendChild(el);
        pieces.push(el);
        order.push(i);
      }
    }
  }

  function layout(){
    const W = puzzle.clientWidth;
    const H = puzzle.clientHeight;
    const w = W / N;
    const h = H / N;
    for(let i=0;i<pieces.length;i++){
      const idx = order[i]; // –≥–¥–µ —Å—Ç–æ–∏—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç i? –ù–µ—Ç ‚Äî –Ω–∞–æ–±–æ—Ä–æ—Ç: i‚Äë–∞—è —è—á–µ–π–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—É—Å–æ–∫ —Å –∏–Ω–¥–µ–∫—Å–æ–º order[i]
      const r = Math.floor(i / N);
      const c = i % N;
      const el = pieces[idx];
      el.style.left = `${(c*100)/N}%`;
      el.style.top  = `${(r*100)/N}%`;
    }
  }

  function shuffle(){
    // –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –§–∏—à–µ—Ä–∞‚Äë–ô–µ—Ç—Å–∞
    for(let i=order.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [order[i], order[j]] = [order[j], order[i]];
    }
    // –∏–∑–±–µ–≥–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Ä–µ—à—ë–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    if (isSolved()) shuffle();
    layout();
  }

  function isSolved(){
    for(let i=0;i<order.length;i++) if(order[i]!==i) return false;
    return true;
  }

  function showMessage(){
    msg.classList.add('show');
    setTimeout(()=> msg.classList.remove('show'), 2200);
  }

  function start(){
    N = parseInt(sizeSel.value,10);
    first = null;
    createPieces();
    const rect = puzzle.getBoundingClientRect();
    shuffle();
  }

  // –∫–ª–∏–∫–∏: –≤—ã–±–∏—Ä–∞–µ–º —è—á–µ–π–∫–∏ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ –∫–ª–∏–∫–∞
  function cellFromEvent(e){
    const rect = puzzle.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const c = Math.min(N-1, Math.max(0, Math.floor(x / rect.width * N)));
    const r = Math.min(N-1, Math.max(0, Math.floor(y / rect.height * N)));
    return r*N + c; // –∏–Ω–¥–µ–∫—Å —è—á–µ–π–∫–∏
  }

  puzzle.addEventListener('click', (e)=>{
    if(!pieces.length) return;
    const cell = cellFromEvent(e);
    if(first==null){
      first = cell;
      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
      const pieceIdx = order[cell];
      pieces[pieceIdx].classList.add('focus');
    }else if(first === cell){
      pieces[order[first]].classList.remove('focus');
      first = null;
    }else{
      // –æ–±–º–µ–Ω –º–µ—Å—Ç–∞–º–∏ –¥–≤—É—Ö —è—á–µ–µ–∫
      pieces[order[first]].classList.remove('focus');
      [order[first], order[cell]] = [order[cell], order[first]];
      layout();
      first = null;
      if(isSolved()){
        puzzle.classList.add('solved');
        showMessage();
      } else {
        puzzle.classList.remove('solved');
      }
    }
  });

  // –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (–¥–ª—è –º—ã—à–∏/—Ç–∞—á–∞) ‚Äî —Ç—è–Ω–µ–º —è—á–µ–π–∫—É –∏ –º–µ–Ω—è–µ–º —Å —Ç–æ–π, –Ω–∞–¥ –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–ø—É—Å—Ç–∏–ª–∏
  let dragCell = null;
  puzzle.addEventListener('mousedown', e=>{ dragCell = cellFromEvent(e); pieces[order[dragCell]].classList.add('focus'); });
  window.addEventListener('mouseup', e=>{
    if(dragCell==null) return;
    const over = (e.target.closest('#puzzle')) ? cellFromEvent(e) : dragCell;
    pieces[order[dragCell]].classList.remove('focus');
    if(over !== dragCell){
      [order[dragCell], order[over]] = [order[over], order[dragCell]];
      layout();
      if(isSolved()){ puzzle.classList.add('solved'); showMessage(); }
      else puzzle.classList.remove('solved');
    }
    dragCell=null;
  });

  // —Ç–∞—á‚Äë–ø–æ–¥–¥–µ—Ä–∂–∫–∞
  puzzle.addEventListener('touchstart', e=>{ dragCell = cellFromEvent(e.touches[0]); pieces[order[dragCell]].classList.add('focus'); },{passive:true});
  puzzle.addEventListener('touchend', e=>{ if(dragCell!=null){ pieces[order[dragCell]].classList.remove('focus'); dragCell=null; } });
  puzzle.addEventListener('touchmove', e=>{ e.preventDefault(); },{passive:false});

  // –∫–Ω–æ–ø–∫–∏/–æ–ø—Ü–∏–∏
  startBtn.addEventListener('click', start);
  hintChk.addEventListener('change', ()=>{ ghost.style.display = hintChk.checked ? 'block' : 'none'; });

  // –Ω–∞—á–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
  window.addEventListener('resize', ()=> layout());
  createPieces();
  shuffle();
})();
</script>
</body>
</html>
